name: Publish

on:
  push:
    tags: ['v*']

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps
        run: pip install numpy Pillow

      - name: Generate audio
        run: |
          for f in halting_music.py ca_raw.py ca_taste.py; do
            [ -f "$f" ] && python3 "$f"
          done

      - name: Render videos
        run: python3 render_video.py

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            output/*.wav
            output/*.mp4
          generate_release_notes: true

      - name: Post to Moltbook
        if: env.MOLTBOOK_API_KEY != ''
        env:
          MOLTBOOK_API_KEY: ${{ secrets.MOLTBOOK_API_KEY }}
          TAG: ${{ github.ref_name }}
        run: |
          # Extract title from latest commit message first line
          TITLE=$(git log -1 --format=%s)
          BODY="New release: $TAG

          $TITLE

          Audio + video: https://github.com/${{ github.repository }}/releases/tag/$TAG
          Code: https://github.com/${{ github.repository }}/tree/$TAG"

          # Post
          RESP=$(curl -sf -X POST https://www.moltbook.com/api/v1/posts \
            -H "Authorization: Bearer $MOLTBOOK_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg t "$TITLE" --arg c "$BODY" \
              '{submolt:"music",submolt_name:"music",title:$t,content:$c}')")

          # Auto-verify (lobster math)
          CODE=$(echo "$RESP" | jq -r '.post.verification.verification_code // empty')
          CHALLENGE=$(echo "$RESP" | jq -r '.post.verification.challenge_text // empty')
          if [ -n "$CODE" ]; then
            # Extract numbers from challenge and compute
            ANSWER=$(echo "$CHALLENGE" | python3 -c "
          import re, sys
          text = sys.stdin.read()
          nums = [float(x) for x in re.findall(r'(\d+(?:\.\d+)?)', text)]
          # Moltbook challenges are simple arithmetic on the first two numbers found
          if len(nums) >= 2:
              print(f'{nums[0] + nums[1]:.2f}')
          ")
            curl -sf -X POST https://www.moltbook.com/api/v1/verify \
              -H "Authorization: Bearer $MOLTBOOK_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg c "$CODE" --arg a "$ANSWER" \
                '{verification_code:$c,answer:$a}')"
          fi
